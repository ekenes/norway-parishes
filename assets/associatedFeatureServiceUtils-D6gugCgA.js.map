{"version":3,"file":"associatedFeatureServiceUtils-D6gugCgA.js","sources":["../../node_modules/@arcgis/core/layers/support/associatedFeatureServiceUtils.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.31/esri/copyright.txt for details.\n*/\nimport{id as e}from\"../../kernel.js\";import r from\"../../request.js\";import t from\"../../core/Error.js\";import{throwIfAbortError as n}from\"../../core/promiseUtils.js\";import{parse as a}from\"./arcgisLayerUrl.js\";import o from\"../../portal/Portal.js\";import i from\"../../portal/PortalItem.js\";async function s(e,r){const n=a(e);if(!n)throw new t(\"invalid-url\",\"Invalid scene service url\");const o={...r,sceneServerUrl:n.url.path,layerId:n.sublayer??void 0};if(o.sceneLayerItem??=await l(o),null==o.sceneLayerItem)return f(o.sceneServerUrl.replace(\"/SceneServer\",\"/FeatureServer\"),o);const i=await y(o);if(!i?.url)throw new t(\"related-service-not-found\",\"Could not find feature service through portal item relationship\");o.featureServiceItem=i;const s=await f(i.url,o);return s.portalItem=i,s}async function l(e){const r=(await c(e)).serviceItemId;if(!r)return null;const t=new i({id:r,apiKey:e.apiKey}),a=await u(e);null!=a&&(t.portal=new o({url:a}));try{return await t.load({signal:e.signal})}catch(s){return n(s),null}}async function c(e){if(e.rootDocument)return e.rootDocument;const t={query:{f:\"json\",...e.customParameters,token:e.apiKey},responseType:\"json\",signal:e.signal};try{const n=await r(e.sceneServerUrl,t);e.rootDocument=n.data}catch{e.rootDocument={}}return e.rootDocument}async function u(t){const a=e?.findServerInfo(t.sceneServerUrl);if(a?.owningSystemUrl)return a.owningSystemUrl;const o=t.sceneServerUrl.replace(/(.*\\/rest)\\/.*/i,\"$1\")+\"/info\";try{const e=(await r(o,{query:{f:\"json\"},responseType:\"json\",signal:t.signal})).data.owningSystemUrl;if(e)return e}catch(i){n(i)}return null}async function f(e,n){const o=a(e);if(!o)throw new t(\"invalid-feature-service-url\",\"Invalid feature service url\");const i=o.url.path,s=n.layerId;if(null==s)return{serverUrl:i};const l=c(n),u=n.featureServiceItem?await n.featureServiceItem.fetchData(\"json\"):null,f=(u?.layers?.[0]||u?.tables?.[0])?.customParameters,y=e=>{const t={query:{f:\"json\",...f},responseType:\"json\",authMode:e,signal:n.signal};return r(i,t)},m=y(\"anonymous\").catch((()=>y(\"no-prompt\"))),[p,d]=await Promise.all([m,l]),v=d?.layers,w=p.data&&p.data.layers;if(!Array.isArray(w))throw new Error(\"expected layers array\");if(Array.isArray(v))for(let r=0;r<Math.min(v.length,w.length);r++){if(v[r].id===s)return{serverUrl:i,layerId:w[r].id}}else if(null!=s&&s<w.length)return{serverUrl:i,layerId:w[s].id};throw new Error(\"could not find matching associated sublayer\")}async function y({sceneLayerItem:e,signal:r}){if(!e)return null;try{const t=(await e.fetchRelatedItems({relationshipType:\"Service2Service\",direction:\"reverse\"},{signal:r})).find((e=>\"Feature Service\"===e.type))||null;if(!t)return null;const n=new i({portal:t.portal,id:t.id});return await n.load(),n}catch(t){return n(t),null}}export{s as findAssociatedFeatureService};\n"],"names":["s","r","n","a","t","o","l","f","i","y","c","u","e","_c","_a","_b","m","p","d","v","w"],"mappings":"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","x_google_ignoreList":[0]}