import{e as It}from"./deduplicate-DF_08fcC.js";import{H as L}from"./InterleavedLayout-DrWQE2qb.js";import{e as c}from"./VertexAttribute-BdZWZuT1.js";import{t as Z}from"./glUtil-7Uu_SdzS.js";import{aR as Ot,aN as w,cc as tt,c$ as St,fG as pt,iu as At}from"./index-Club40b3.js";import{p as Et,o as k,s as ot,P as H,c as rt,_ as ht,A as dt,K as wt,u as Tt}from"./vec32-Aogwsubb.js";function j(t,n,s,r,a,l=2){const h=1/(Math.abs(s)+Math.abs(r)+Math.abs(a)),g=s*h,m=r*h,i=a<=0?(g>=0?1:-1)*(1-Math.abs(m)):g,p=a<=0?(m>=0?1:-1)*(1-Math.abs(g)):m,N=n*l;t[N]=at(i),t[N+1]=at(p)}function at(t){return Ot(Math.round(32767*t),-32767,32767)}const Mt=L().vec3f(c.POSITION).u16(c.COMPONENTINDEX).freeze(),vt=L().vec2u8(c.SIDENESS).freeze();Z(vt);const G=L().vec3f(c.POSITION0).vec3f(c.POSITION1).vec2i16(c.NORMALCOMPRESSED).u16(c.COMPONENTINDEX).u8(c.VARIANTOFFSET,{glNormalized:!0}).u8(c.VARIANTSTROKE).u8(c.VARIANTEXTENSION,{glNormalized:!0}).freeze(),J=L().vec3f(c.POSITION0).vec3f(c.POSITION1).vec2i16(c.NORMALCOMPRESSED).vec2i16(c.NORMAL2COMPRESSED).u16(c.COMPONENTINDEX).u8(c.VARIANTOFFSET,{glNormalized:!0}).u8(c.VARIANTSTROKE).u8(c.VARIANTEXTENSION,{glNormalized:!0}).freeze();c.POSITION0,c.POSITION1,c.COMPONENTINDEX,c.VARIANTOFFSET,c.VARIANTSTROKE,c.VARIANTEXTENSION,c.NORMALCOMPRESSED,c.NORMAL2COMPRESSED,c.SIDENESS;class yt{constructor(){this.position0=w(),this.position1=w(),this.faceNormal0=w(),this.faceNormal1=w(),this.componentIndex=0,this.cosAngle=0}}const W=-1;function Pt(t,n,s){const r=t.vertices.position,a=t.vertices.componentIndex,l=O.position0,h=O.position1,g=O.faceNormal0,m=O.faceNormal1,{edges:i,normals:p}=xt(t),N=i.length/4,A=n.allocate(N);let $=0;const F=N,T=s==null?void 0:s.allocate(F);let B=0,e=0,o=0;z.length=0;for(let d=0;d<N;++d){const v=4*d;r.getVec(i.data[v],l),r.getVec(i.data[v+1],h);const x=z.pushNew();x.index=4*d,x.length=Et(l,h)}z.sort((d,v)=>v.length-d.length);const f=new Array,u=new Array;z.forAll(({length:d,index:v})=>{const x=i.data[v],mt=i.data[v+1],et=i.data[v+2],nt=i.data[v+3],st=nt===W;if(r.getVec(x,l),r.getVec(mt,h),st){const E=3*et;k(g,p.data[E],p.data[E+1],p.data[E+2]),ot(m,g),O.componentIndex=a.get(x),O.cosAngle=H(g,m)}else{let E=3*et;if(k(g,p.data[E],p.data[E+1],p.data[E+2]),E=3*nt,k(m,p.data[E],p.data[E+1],p.data[E+2]),O.componentIndex=a.get(x),O.cosAngle=H(g,m),$t(O,Ct))return;O.cosAngle<-.9999&&ot(m,g)}e+=d,o++,st||Rt(O,Ft)?(n.write(A,$++,O),f.push(d)):Vt(O,gt)&&(T&&s&&s.write(T,B++,O),u.push(d))});const S=new Float32Array(f.reverse()),M=new Float32Array(u.reverse()),y=T&&s?{instancesData:T.slice(0,B),lodInfo:{lengths:M}}:void 0;return{regular:{instancesData:A.slice(0,$),lodInfo:{lengths:S}},silhouette:y,averageEdgeLength:e/o}}function Rt(t,n){return t.cosAngle<n}function $t(t,n){return t.cosAngle>n}function Vt(t,n){const s=St(t.cosAngle);return wt(it,t.position1,t.position0),s*(H(ht(bt,t.faceNormal0,t.faceNormal1),it)>0?-1:1)>n}function xt(t){const n=t.faces.length/3,s=t.faces,r=t.neighbors,a=t.vertices.position;I.length=K.length=0;for(let l=0;l<n;l++){const h=3*l,g=r[h],m=r[h+1],i=r[h+2],p=s[h],N=s[h+1],A=s[h+2];a.getVec(p,V),a.getVec(N,_),a.getVec(A,X),rt(_,_,V),rt(X,X,V),ht(V,_,X),dt(V,V),K.pushArray(V),(g===W||p<N)&&(I.push(p),I.push(N),I.push(l),I.push(g)),(m===W||N<A)&&(I.push(N),I.push(A),I.push(l),I.push(m)),(i===W||A<p)&&(I.push(A),I.push(p),I.push(l),I.push(i))}return{edges:I,normals:K}}class Dt{constructor(){this.index=0,this.length=0}}const z=new tt({allocator:t=>t||new Dt,deallocator:null}),I=new tt({deallocator:null}),K=new tt({deallocator:null}),O=new yt,bt=w(),it=w(),V=w(),_=w(),X=w(),gt=pt(4),Ct=Math.cos(gt),Lt=pt(35),Ft=Math.cos(Lt);function ct(t,n,s){const r=n/3,a=new Uint32Array(s+1),l=new Uint32Array(s+1),h=(e,o)=>{e<o?a[e+1]++:l[o+1]++};for(let e=0;e<r;e++){const o=t[3*e],f=t[3*e+1],u=t[3*e+2];h(o,f),h(f,u),h(u,o)}let g=0,m=0;for(let e=0;e<s;e++){const o=a[e+1],f=l[e+1];a[e+1]=g,l[e+1]=m,g+=o,m+=f}const i=new Uint32Array(6*r),p=a[s],N=(e,o,f)=>{if(e<o){const u=a[e+1]++;i[2*u]=o,i[2*u+1]=f}else{const u=l[o+1]++;i[2*p+2*u]=e,i[2*p+2*u+1]=f}};for(let e=0;e<r;e++){const o=t[3*e],f=t[3*e+1],u=t[3*e+2];N(o,f,e),N(f,u,e),N(u,o,e)}const A=(e,o)=>{const f=2*e,u=o-e;for(let S=1;S<u;S++){const M=i[f+2*S],y=i[f+2*S+1];let d=S-1;for(;d>=0&&i[f+2*d]>M;d--)i[f+2*d+2]=i[f+2*d],i[f+2*d+3]=i[f+2*d+1];i[f+2*d+2]=M,i[f+2*d+3]=y}};for(let e=0;e<s;e++)A(a[e],a[e+1]),A(p+l[e],p+l[e+1]);const $=new Int32Array(3*r),F=(e,o)=>e===t[3*o]?0:e===t[3*o+1]?1:e===t[3*o+2]?2:-1,T=(e,o)=>{const f=F(e,o);$[3*o+f]=-1},B=(e,o,f,u)=>{const S=F(e,o);$[3*o+S]=u;const M=F(f,u);$[3*u+M]=o};for(let e=0;e<s;e++){let o=a[e];const f=a[e+1];let u=l[e];const S=l[e+1];for(;o<f&&u<S;){const M=i[2*o],y=i[2*p+2*u];M===y?(B(e,i[2*o+1],y,i[2*p+2*u+1]),o++,u++):M<y?(T(e,i[2*o+1]),o++):(T(y,i[2*p+2*u+1]),u++)}for(;o<f;)T(e,i[2*o+1]),o++;for(;u<S;)T(i[2*p+2*u],i[2*p+2*u+1]),u++}return $}const q=.7;let Nt=class{updateSettings(n){this.settings=n,this._edgeHashFunction=n.reducedPrecision?zt:Bt}write(n,s,r){U.seed=this._edgeHashFunction(r);const a=U.getIntRange(0,255),l=U.getIntRange(0,this.settings.variants-1),h=U.getFloat(),g=255*(.5*_t(-(1-Math.min(h/q,1))+Math.max(0,h-q)/(1-q),1.2)+.5);n.position0.setVec(s,r.position0),n.position1.setVec(s,r.position1),n.componentIndex.set(s,r.componentIndex),n.variantOffset.set(s,a),n.variantStroke.set(s,l),n.variantExtension.set(s,g)}};const P=new Float32Array(6),R=new Uint32Array(P.buffer),C=new Uint32Array(1);function Bt(t){return P[0]=t.position0[0],P[1]=t.position0[1],P[2]=t.position0[2],P[3]=t.position1[0],P[4]=t.position1[1],P[5]=t.position1[2],C[0]=31*(31*(31*(31*(31*(166811+R[0])+R[1])+R[2])+R[3])+R[4])+R[5],C[0]}function zt(t){const n=P;n[0]=D(t.position0[0]),n[1]=D(t.position0[1]),n[2]=D(t.position0[2]),n[3]=D(t.position1[0]),n[4]=D(t.position1[1]),n[5]=D(t.position1[2]),C[0]=5381;for(let s=0;s<R.length;s++)C[0]=31*C[0]+R[s];return C[0]}const lt=1e4;function D(t){return Math.round(t*lt)/lt}function _t(t,n){return Math.abs(t)**n*Math.sign(t)}class Q{constructor(){this._commonWriter=new Nt}updateSettings(n){this._commonWriter.updateSettings(n)}allocate(n){return G.createBuffer(n)}write(n,s,r){this._commonWriter.write(n,s,r),Tt(b,r.faceNormal0,r.faceNormal1),dt(b,b);const{typedBuffer:a,typedBufferStride:l}=n.normalCompressed;j(a,s,b[0],b[1],b[2],l)}}Q.Layout=G,Q.glLayout=Z(G,1);class Y{constructor(){this._commonWriter=new Nt}updateSettings(n){this._commonWriter.updateSettings(n)}allocate(n){return J.createBuffer(n)}write(n,s,r){this._commonWriter.write(n,s,r);{const{typedBuffer:a,typedBufferStride:l}=n.normalCompressed;j(a,s,r.faceNormal0[0],r.faceNormal0[1],r.faceNormal0[2],l)}{const{typedBuffer:a,typedBufferStride:l}=n.normal2Compressed;j(a,s,r.faceNormal1[0],r.faceNormal1[1],r.faceNormal1[2],l)}}}Y.Layout=J,Y.glLayout=Z(J,1);const b=w(),U=new At;function Jt(t){const n=Xt(t.data,t.skipDeduplicate,t.indices,t.indicesLength);return ut.updateSettings(t.writerSettings),ft.updateSettings(t.writerSettings),Pt(n,ut,ft)}function Xt(t,n,s,r){if(n){const h=ct(s,r,t.count);return new Ut(s,r,h,t)}const a=It(t.buffer,t.stride/4,{originalIndices:s}),l=ct(a.indices,r,a.uniqueCount);return{faces:a.indices,facesLength:a.indices.length,neighbors:l,vertices:Mt.createView(a.buffer)}}class Ut{constructor(n,s,r,a){this.faces=n,this.facesLength=s,this.neighbors=r,this.vertices=a}}const ut=new Q,ft=new Y,Qt=L().vec3f(c.POSITION0).vec3f(c.POSITION1),Yt=L().vec3f(c.POSITION0).vec3f(c.POSITION1).u16(c.COMPONENTINDEX);export{Mt as E,Qt as d,Jt as f,Yt as m,Pt as p,Xt as u};
//# sourceMappingURL=edgeProcessing-BTqv5JYq.js.map
